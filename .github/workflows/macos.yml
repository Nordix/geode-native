name: MacOS CI

on:
  push:

env:
  GEODE_VERSION: 1.13.2

jobs:
  unit-test:
    if: "!contains(github.event.head_commit.message, 'skip-macos-ci')"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-latest ]
    steps:
      - name: Checkout source
        uses: actions/checkout@v2
      - name: Cache geode
        uses: actions/cache@v2.1.4
        id: cache-geode-mac
        with:
          path: ~/apache-geode
          key: apache-geode-mac
      - name: Install geode
        env:
          CACHE_HIT: ${{steps.cache-geode-mac.outputs.cache-hit}}
        run: |
          if [[ "$CACHE_HIT" != 'true' ]]; then
            wget "https://www.apache.org/dyn/closer.cgi?action=download&filename=geode/${GEODE_VERSION}/apache-geode-${GEODE_VERSION}.tgz" --quiet -O - | tar xzf - && mv apache-geode-${GEODE_VERSION} ~/apache-geode
          fi
      - name: Install doxygen
        run: brew install doxygen
      - name: Create build directory
        run: mkdir build
      - name: Configure CMake project
        run: export GEODE_HOME=~/apache-geode && cmake -Bbuild -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl\@1.1/
      - name: Build targets
        run: cmake --build build/ --target apache-geode_unittests -- -j4
      - name: Execute tests
        run: |
          if ! build/cppcache/test/apache-geode_unittests --gtest_shuffle; then
            echo "retrying tests"
            build/cppcache/test/apache-geode_unittests --gtest_shuffle
          fi

  old-integration-test:
    if: "!contains(github.event.head_commit.message, 'skip-macos-ci')"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-latest ]
    steps:
      - name: Checkout source
        uses: actions/checkout@v2
      - name: Cache geode
        uses: actions/cache@v2.1.4
        id: cache-geode-mac
        with:
          path: ~/apache-geode
          key: apache-geode-mac
      - name: Install geode
        env:
          CACHE_HIT: ${{steps.cache-geode-mac.outputs.cache-hit}}
        run: |
          if [[ "$CACHE_HIT" != 'true' ]]; then
            wget "https://www.apache.org/dyn/closer.cgi?action=download&filename=geode/${GEODE_VERSION}/apache-geode-${GEODE_VERSION}.tgz" --quiet -O - | tar xzf - && mv apache-geode-${GEODE_VERSION} ~/apache-geode
          fi
      - name: Install doxygen
        run: brew install doxygen
      - name: Create build directory
        run: mkdir build
      - name: Configure CMake project
        run: export GEODE_HOME=~/apache-geode && cmake -Bbuild -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl\@1.1/
      - name: Build targets
        run: cmake --build build/ --target javaobject -- -j4 && cmake --build build/ --target unit_test_callbacks -- -j4 && cmake --build build/ --target cppcache-integration-tests -- -j4
      - name: Execute tests
        run: cmake -E chdir build/cppcache/integration-test ctest --timeout 500 -C Debug -j1 --output-on-failure --schedule-random --repeat until-pass:3

  new-integration-test:
    if: "!contains(github.event.head_commit.message, 'skip-macos-ci')"
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-latest ]
    steps:
      - name: Checkout source
        uses: actions/checkout@v2
      - name: Cache geode
        uses: actions/cache@v2.1.4
        id: cache-geode-mac
        with:
          path: ~/apache-geode
          key: apache-geode-mac
      - name: Install geode
        env:
          CACHE_HIT: ${{steps.cache-geode-mac.outputs.cache-hit}}
        run: |
          if [[ "$CACHE_HIT" != 'true' ]]; then
            wget "https://www.apache.org/dyn/closer.cgi?action=download&filename=geode/${GEODE_VERSION}/apache-geode-${GEODE_VERSION}.tgz" --quiet -O - | tar xzf - && mv apache-geode-${GEODE_VERSION} ~/apache-geode
          fi
      - name: Install doxygen
        run: brew install doxygen
      - name: Create build directory
        run: mkdir build
      - name: Configure CMake project
        run: export GEODE_HOME=~/apache-geode && cmake -Bbuild -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl\@1.1/
      - name: Build targets
        run: cmake --build build/ --target cpp-integration-test -- -j4
      - name: Execute tests
        run: cmake -E chdir build/cppcache/integration/test ctest -j2 --output-on-failure --schedule-random --repeat until-pass:3
